<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת כוורת - Web Shell</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="background-container"></div>
    <img src="images/background.jpg" alt="" class="background-image" onerror="this.style.display='none'">
    <div class="animated-bg">
        <div class="grid-lines"></div>
    </div>

    <div class="clock-container">
        <div class="clock" id="clock">00:00:00</div>
        <div class="date" id="date"></div>
    </div>

    <div class="screen-title" id="screenTitle">כוורת 1</div>

    <div class="main-container">
        <!-- Login Screen -->
        <div class="card" id="loginScreen">
            <h1 class="card-title">כניסה למערכת</h1>

            <div class="input-display" id="inputDisplay">
                <span id="inputValue"></span>
                <span class="cursor" style="animation: blink 1s infinite;">|</span>
            </div>

            <div class="keypad" id="keypad">
                <button class="key" data-digit="1">1</button>
                <button class="key" data-digit="2">2</button>
                <button class="key" data-digit="3">3</button>
                <button class="key" data-digit="4">4</button>
                <button class="key" data-digit="5">5</button>
                <button class="key" data-digit="6">6</button>
                <button class="key" data-digit="7">7</button>
                <button class="key" data-digit="8">8</button>
                <button class="key" data-digit="9">9</button>
                <button class="key delete" data-action="delete">⌫</button>
                <button class="key" data-digit="0">0</button>
                <button class="key enter" data-action="enter" style="grid-column: span 3;">אישור ⏎</button>
            </div>

            <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                הזן את מספר הזיהוי שלך או העבר את התג
            </p>
        </div>

        <!-- User Result Screen -->
        <div class="card hidden" id="resultScreen">
            <div class="timeout-bar-container" id="resultTimeoutContainer" style="display: none;">
                <div class="timeout-bar" id="resultTimeoutBar" style="width: 100%"></div>
            </div>
            
            <div class="welcome-message" id="welcomeMessage"></div>
            
            <div class="status-message" id="statusMessage"></div>
            
            <div class="box-info" id="boxInfo">
                <div class="box-label">תא מספר</div>
                <div class="box-number" id="boxNumber"></div>
                <div class="ip-address" id="ipAddress"></div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectUser()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    התנתק מהמערכת
                </button>
                <button class="btn btn-secondary" onclick="backToLogin()">חזור</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel hidden" id="adminPanel">
            <div class="admin-header">
                <h1 class="admin-title">לוח בקרה - מנהל</h1>
                <div class="admin-nav">
                    <button class="btn btn-secondary" onclick="showAdminTab('mappings')">מיפויים</button>
                    <button class="btn btn-secondary" onclick="showAdminTab('boxes')">תאים</button>
                    <button class="btn btn-secondary" onclick="showAdminTab('hives')">כוורות</button>
                    <button class="btn btn-secondary" onclick="showAdminTab('identities')">זהויות</button>
                    <button class="btn btn-secondary" onclick="showAdminTab('admins')">מנהלים</button>
                    <button class="btn btn-secondary" onclick="showAdminTab('stats')">סטטיסטיקות</button>
                    <button class="btn btn-warning" onclick="clearHistory()">מחק היסטוריה</button>
                    <button class="btn btn-danger" onclick="resetSystem()">איפוס מערכת</button>
                    <button class="btn btn-primary" onclick="backToLogin()">יציאה</button>
                </div>
            </div>

            <!-- Mappings Tab -->
            <div class="admin-tab" id="mappingsTab">
                <div class="admin-card">
                    <h3>מיפויים נוכחיים</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>מזהה משתמש</th>
                                    <th>שם</th>
                                    <th>תא</th>
                                    <th>כוורת</th>
                                    <th>זמן התחברות</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="mappingsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Boxes Tab -->
            <div class="admin-tab hidden" id="boxesTab">
                <div class="admin-grid">
                    <div class="admin-card">
                        <h3>הוספת תא חדש</h3>
                        <div class="form-group">
                            <label>כוורת</label>
                            <select id="newBoxHive"></select>
                        </div>
                        <div class="form-group">
                            <label>מספר תא</label>
                            <input type="number" id="newBoxNumber" min="1">
                        </div>
                        <div class="form-group">
                            <label>כתובת IP</label>
                            <input type="text" id="newBoxIp" placeholder="10.1.1.1">
                            <button class="btn btn-secondary" style="margin-top: 10px;" onclick="suggestIp()">הצע כתובת</button>
                        </div>
                        <button class="btn btn-success" onclick="addBox()">הוסף תא</button>
                    </div>
                    <div class="admin-card">
                        <h3>תאים קיימים</h3>
                        <div class="form-group" style="display: flex; gap: 15px; align-items: center;">
                            <div style="flex: 1;">
                                <label>סנן לפי כוורת</label>
                                <select id="filterBoxHive" onchange="loadBoxes()">
                                    <option value="">כל הכוורות</option>
                                </select>
                            </div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; white-space: nowrap; margin-top: 20px;">
                                <input type="checkbox" id="sortBoxesById" onchange="loadBoxes()" checked>
                                <span>מיין לפי מספר תא</span>
                            </label>
                        </div>
                        <div class="box-grid" id="boxesGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Hives Tab -->
            <div class="admin-tab hidden" id="hivesTab">
                <div class="admin-grid">
                    <div class="admin-card">
                        <h3>הוספת כוורת חדשה</h3>
                        <div class="form-group">
                            <label>שם כוורת</label>
                            <input type="text" id="newHiveName" placeholder="כוורת 2">
                        </div>
                        <button class="btn btn-success" onclick="addHive()">הוסף כוורת</button>
                    </div>
                    <div class="admin-card">
                        <h3>כוורות קיימות</h3>
                        <div class="hive-selector" id="hivesGrid"></div>
                        <div style="margin-top: 20px;">
                            <h4>החלף כוורת נוכחית</h4>
                            <select id="currentHiveSelect" onchange="changeCurrentHive()"></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Identities Tab -->
            <div class="admin-tab hidden" id="identitiesTab">
                <div class="admin-grid">
                    <div class="admin-card">
                        <h3>הוספת מיפוי זהות</h3>
                        <div class="form-group">
                            <label>מזהה</label>
                            <input type="text" id="newIdentityId" placeholder="123456">
                        </div>
                        <div class="form-group">
                            <label>שם</label>
                            <input type="text" id="newIdentityName" placeholder="ישראל ישראלי">
                        </div>
                        <button class="btn btn-success" onclick="addIdentity()">הוסף מיפוי</button>
                    </div>
                    <div class="admin-card">
                        <h3>מיפויי זהות קיימים</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>מזהה</th>
                                        <th>שם</th>
                                        <th>פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="identitiesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admins Tab -->
            <div class="admin-tab hidden" id="adminsTab">
                <div class="admin-grid">
                    <div class="admin-card">
                        <h3>הוספת מנהל</h3>
                        <div class="form-group">
                            <label>מזהה</label>
                            <input type="text" id="newAdminId" placeholder="123456">
                        </div>
                        <div class="form-group">
                            <label>שם</label>
                            <input type="text" id="newAdminName" placeholder="ישראל ישראלי">
                        </div>
                        <button class="btn btn-success" onclick="addAdmin()">הוסף מנהל</button>
                    </div>
                    <div class="admin-card">
                        <h3>מנהלים קיימים</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>מזהה</th>
                                        <th>שם</th>
                                        <th>פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="adminsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div class="admin-tab hidden" id="statsTab">
                <div class="admin-grid">
                    <div class="admin-card stat-card">
                        <div class="stat-value" id="statTotalUsers">0</div>
                        <div class="stat-label">משתמשים מחוברים</div>
                    </div>
                    <div class="admin-card stat-card">
                        <div class="stat-value" id="statTotalBoxes">0</div>
                        <div class="stat-label">סה"כ תאים</div>
                    </div>
                    <div class="admin-card stat-card">
                        <div class="stat-value" id="statFreeBoxes">0</div>
                        <div class="stat-label">תאים פנויים</div>
                    </div>
                    <div class="admin-card stat-card">
                        <div class="stat-value" id="statOccupiedBoxes">0</div>
                        <div class="stat-label">תאים תפוסים</div>
                    </div>
                </div>
                <div class="admin-card" style="margin-top: 20px;">
                    <h3>משתמשים לפי יום k(7 ימים אחרונים)</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>תאריך</th>
                                    <th>מספר משתמשים</th>
                                </tr>
                            </thead>
                            <tbody id="usersPerDayTable"></tbody>
                        </table>
                    </div>
                </div>
                <div class="admin-card" style="margin-top: 20px;">
                    <h3>שימוש בתאים לפי שעה (שבוע אחרון)</h3>
                    <div style="padding: 20px;">
                        <canvas id="hourlyUsageChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                <div class="admin-card" style="margin-top: 20px;">
                    <h3>שימוש בתאים</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>תא</th>
                                    <th>כוורת</th>
                                    <th>סטטוס</th>
                                    <th>מספר שימושים</th>
                                </tr>
                            </thead>
                            <tbody id="boxUsageTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Choice Modal -->
    <div class="modal-overlay" id="adminChoiceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">בחר פעולה</h2>
            </div>
            <p style="text-align: center; margin-bottom: 20px;">הזדהית כמנהל. מה ברצונך לעשות?</p>
            <div class="action-buttons" style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn btn-primary" onclick="proceedAsAdmin()" style="grid-column: span 3;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 8px;">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                    כניסה ללוח בקרה
                </button>
                <button class="btn btn-success" onclick="proceedAsUser()" id="adminGetBoxBtn" style="grid-column: span 3; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; height: 100%; background: rgba(255, 255, 255, 0.3); width: 0%; transition: width 3s linear;" id="adminChoiceProgress"></div>
                    <div style="position: relative; z-index: 1; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 8px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <rect x="7" y="7" width="3" height="3"></rect>
                        </svg>
                        קבלת תא
                    </div>
                </button>
                <button class="btn btn-secondary" onclick="closeModal('adminChoiceModal'); clearAdminChoiceTimeout(); backToLogin();" style="grid-column: span 3;">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">אישור מחיקה</h2>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <p id="deleteModalText">האם אתה בטוח שברצונך למחוק?</p>
            <div class="action-buttons" style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn btn-danger" id="confirmDeleteBtn" style="grid-column: span 3;">מחק</button>
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')" style="grid-column: span 3;">ביטול</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/hive.js"></script>
    <script src="js/chart.min.js"></script>
</body>
</html>
